#
#  Licensed to the Apache Software Foundation (ASF) under one
#  or more contributor license agreements.  See the NOTICE file
#  distributed with this work for additional information
#  regarding copyright ownership.  The ASF licenses this file
#  to you under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance
#  with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing,
#  software distributed under the License is distributed on an
#  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#  KIND, either express or implied.  See the License for the
#  specific language governing permissions and limitations
#  under the License.
#
# The :launchpad feature defines Sling's launchpad version
# Only a single artifact is allowed within this feature.
#
[feature name=peregrine]

[artifacts startLevel=30]
    com.peregrine-cms/login/1.0-SNAPSHOT
# All 3 artifacts bundle together into one Sling instance does not work
#    com.eclipsesource.j2v8/j2v8_linux_x86_64/4.6.0
#    com.eclipsesource.j2v8/j2v8_macosx_x86_64/4.6.0
#    com.eclipsesource.j2v8/j2v8_win32_x86/4.6.0

[:repoinit]

#
# ATTENTION: add new Repoinit script into the Repoinit Config file inside base/core
#            so that the necessary users / groups / permissions are updated when a client
#            upgrades
# Also: keep Service User Mappings both here and in the run mode configurations to avoid
#       sporadic errors in the logs
#

# Create the two System User Peregrine uses for Service Resource Resolvers

    create service user distribution-agent-user

# Create the necessary folders to apply permissions below otherwise the Launchpad will fail during startup

    create path (sling:Folder) /etc
    create path (sling:Folder) /etc/distribution
    create path (sling:Folder) /libs
    create path (sling:Folder) /libs/sling
    create path (sling:Folder) /libs/sling/distribution
    create path (sling:Folder) /var
    create path (sling:Folder) /var/sling
    create path (sling:Folder) /var/sling/distribution
    create path (sling:Folder) /var/sling/distribution/packages

# Set Permissions for Sling Distribution

    set ACL for distribution-agent-user
        allow jcr:all on /content
        allow jcr:all on /etc/distribution
        allow jcr:all on /libs/sling/distribution
        allow jcr:all on /var/sling/distribution/packages
    end

# Set Repository ACL for Sling Distribution

    set repository ACL for distribution-agent-user
        allow jcr:all
    end

[configurations]

# We keep the Service User Mappings here to make startup of Peregrine as Error free as possible when using Peregrine Sling

    org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl.amended-sitemaps
        user.mapping=[
            "com.peregrine-cms.base.core:sitemaps\=sitemaps-cache"
        ]

    org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl.amended-distributionEventHandler
        user.mapping=[
            "com.peregrine-cms.admin.core:peregrine-distribution-sub-service\=distribution-agent-user",
            "com.peregrine-cms.replication.core:peregrine-distribution-sub-service\=distribution-agent-user"
        ]

    org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl.amended-distributionAgentService
        user.mapping=[
            "org.apache.sling.distribution.core:defaultAgentService\=distribution-agent-user",
            "org.apache.sling.distribution.core\=distribution-agent-user",
            "com.peregrine-cms.distribution:test-distribution\=distribution-agent-user"
        ]

    org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl.amended-nodejs
        user.mapping=[
            "com.peregrine-cms.nodejs:nodejs-service\=nodejs-service-user",
            "com.peregrine-cms.nodejs.scripts:nodejs-service\=nodejs-service-user",
            "com.peregrine-cms.nodejs.j2v8:nodejs-service\=nodejs-service-user"
        ]

    org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl.amended-peregrine
        user.mapping=[
            "com.peregrine-cms.admin.core:peregrine-services\=peregrine-service-user"
        ]
